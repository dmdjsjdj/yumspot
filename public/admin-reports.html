<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>관리자 - 신고 관리</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body{font-family:Arial,sans-serif;background:#eef3f9;margin:0;}
  .header{background:#90CAF9;color:#fff;padding:16px;font-size:20px;}
  .wrap{max-width:1000px;margin:16px auto;background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08);}
  table{width:100%;border-collapse:collapse;}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top;}
  .btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;}
  .btn.hide{background:#ef5350;color:#fff;}
  .btn.show{background:#66bb6a;color:#fff;}
  .btn.del{background:#9e9e9e;color:#fff;}
  .pill{display:inline-block;padding:2px 8px;border-radius:12px;background:#f1f3f5;font-size:12px;}
</style>
</head>
<body>
<div class="header">관리자 - 신고 관리</div>

<div style="max-width:1000px; margin:16px auto; text-align:right;">
  <button onclick="history.back()" 
          style="background:#90CAF9; color:white; border:none; border-radius:6px;
                 padding:8px 14px; cursor:pointer; font-size:14px;">
    ← 뒤로가기
  </button>
</div>

<div class="wrap">
  <table id="tbl"><thead>
    <tr>
      <th>신고일</th>
      <th>리뷰</th>
      <th>신고자</th>
      <th>사유</th>
      <th>조치</th>
    </tr>
  </thead><tbody></tbody></table>
</div>

<script>
async function guardAdmin(){
  const r = await fetch('/api/me', { credentials: 'include' });
  if (r.status !== 200) { alert('로그인이 필요합니다.'); location.href='login.html'; return false; }
  const me = await r.json();
  if (me?.role !== 'admin') { alert('관리자만 접근 가능합니다.'); location.href='/'; return false; }
  return true;
}

(async () => {
  if (await guardAdmin()) {
    load();   // ← 기존에 있던 신고목록 로드 함수
  }
})();
</script>

<script>
async function load(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '<tr><td colspan="5">불러오는 중...</td></tr>';
  try{
    const r = await fetch('/api/admin/reports', { credentials:'include' });
    if (r.status === 401) { alert('로그인 필요'); location.href='login.html'; return; }
    if (r.status === 403) { alert('관리자만 접근 가능합니다.'); history.back(); return; }
    const rows = await r.json();

    tb.innerHTML = '';
    if (!rows.length) { tb.innerHTML = '<tr><td colspan="5">신고가 없습니다.</td></tr>'; return; }

    rows.forEach(row=>{
      const tr = document.createElement('tr');
      const created = new Date(row.created_at).toLocaleString('ko-KR');
      const review = row.reviews;
      const user = row.users;

      tr.innerHTML = `
        <td>${created}</td>
        <td>
          <div><a href="reviewdetail.html?id=${review.id}" target="_blank">${review.title || '(제목없음)'}</a></div>
          <div class="pill">${review.restaurant_name || ''}</div>
          <div>${review.hidden ? '상태: 숨김' : '상태: 노출'}</div>
        </td>
        <td>${user?.nickname || user?.email || user?.id || ''}</td>
        <td style="max-width:300px;white-space:pre-wrap;">${row.reason || ''}</td>
        <td>
          <button class="btn ${review.hidden?'show':'hide'}" data-act="toggle" data-id="${review.id}" data-hidden="${review.hidden?1:0}">
            ${review.hidden ? '노출' : '숨김'}
          </button>
          <button class="btn del" data-act="del" data-id="${row.id}">신고 삭제</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    // 액션 핸들러
    tb.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if (!btn) return;
      const act = btn.dataset.act;
      if (act === 'toggle'){
        const id = btn.dataset.id;
        const hidden = btn.dataset.hidden === '1';
        const r = await fetch(`/api/admin/reviews/${id}/hide`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ hidden: !hidden })
        });
        if (!r.ok) { alert('조치 실패'); return; }
        load();
      } else if (act === 'del'){
        const id = btn.dataset.id;
        if (!confirm('이 신고를 삭제할까요?')) return;
        const r = await fetch(`/api/admin/reports/${id}`, { method:'DELETE', credentials:'include' });
        if (!r.ok) { alert('삭제 실패'); return; }
        load();
      }
    }, { once:true });

  }catch(e){
    tb.innerHTML = '<tr><td colspan="5">불러오기 실패</td></tr>';
    console.error(e);
  }
}
load();
</script>
</body>
</html>
