<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내 리뷰 - YumSpot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#E3F2FD; margin:0; }
    .header { text-align:center; padding:20px; font-size:24px; font-weight:bold; background:#90CAF9; color:#fff; }
    .header a { color:#fff; text-decoration:none; }
    .navbar { background:#90CAF9; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .center-links { flex:1; display:flex; justify-content:center; gap:30px; margin-left:90px; }
    .center-links a, .auth-links a { color:#fff; text-decoration:none; }
    .auth-links { display:flex; gap:7px; }

    .container { max-width:980px; margin:20px auto; padding:0 10px; }
    .top-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .right-actions { display:flex; gap:8px; align-items:center; }
    .select { padding:8px 10px; border:1px solid #90CAF9; border-radius:6px; background:#fff; }
    .btn { display:inline-block; padding:8px 12px; background:#64B5F6; color:#fff; border-radius:6px; text-decoration:none; border:none; cursor:pointer; }
    .btn.secondary { background:#90CAF9; }
    .btn.danger { background:#ef5350; }

    .review-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:16px; margin-top:16px; }
    .card { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 5px rgba(0,0,0,.1); cursor:pointer; position:relative; }
    .rating { letter-spacing:1px; }
    .empty { opacity:.35; }
    .cta { margin-top:10px; display:flex; gap:8px; }
    .state { padding:32px 0; color:#444; }

    .btn.secondary.active { background:#42A5F5; color:#fff; }
  </style>
  <script src="/utils/categoryLists.js"></script>
</head>
<body>
  <div class="header"><a href="/">YumSpot - 맛집을 찾아보자!</a></div>
  <div class="navbar">
    <div class="center-links">
      <a href="regionreview.html">지역별</a>
      <a href="foodreview.html">음식</a>
      <a href="myreview.html">내 리뷰</a>
    </div>
    <div class="auth-links">
      <a href="login.html">로그인</a>
      <a href="signup.html">회원가입</a>
    </div>
  </div>

  <div class="container">
    <div class="top-actions">
      <h2>내 리뷰</h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <div id="tabs" style="display:flex; gap:6px; margin-right:8px;">
          <button class="btn secondary" data-mode="mine">내 리뷰</button>
          <button class="btn secondary" data-mode="bookmarks">북마크</button>
        </div>

        <select id="sortSelect" class="btn" style="background:#fff; color:#333;">
          <option value="latest">날짜순(최신)</option>
          <option value="oldest">날짜순(오래된)</option>
          <option value="ratingDesc">별점순(높은↓)</option>
          <option value="ratingAsc">별점순(낮은↑)</option>
        </select>
        <a class="btn" href="plusreviewpage.html">+ 리뷰 작성</a>
      </div>
    </div>

    <div id="grid" class="review-grid"></div>
    <div id="state" class="state"></div>
  </div>

  <script>
    let CURRENT_TAB = 'mine'; // 'mine' | 'bookmarks'
    let MY_LIST = [];

    // 날짜 포맷
    function fmtDate(s){
      if(!s) return '-';
      const d = new Date(s);
      return isNaN(d.getTime()) ? '-' :
        d.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'});
    }

    // 카드 렌더
    function render(list){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      if(!list || list.length === 0){
        grid.innerHTML = `<p>${
          CURRENT_TAB === 'mine'
            ? '아직 내 리뷰가 없습니다. 상단의 “+ 리뷰 작성”으로 첫 리뷰를 남겨보세요!'
            : '북마크한 리뷰가 없습니다. 상세 페이지에서 ★ 버튼으로 북마크해보세요!'
        }</p>`;
        return;
      }

    list.forEach(review => {
      const stars = '★'.repeat(Number(review.rating)||0) +
                    '<span class="empty">' + '☆'.repeat(5-(Number(review.rating)||0)) + '</span>';

      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <h3>${review.title}</h3>
        <p class="rating">${stars}</p>
        <p>${review.restaurant_name ?? ''}</p>
        <p class="meta">작성일: ${
          review.created_at
            ? new Date(review.created_at).toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'})
            : '-'
        }</p>

        ${
          CURRENT_TAB === 'mine'
            ? `<div class="cta" style="margin-top:10px; display:flex; gap:8px;">
                <button class="btn secondary btn-edit">수정</button>
                <button class="btn danger btn-del">삭제</button>
              </div>`
            : ``
        }
      `;

      // 카드 전체 클릭 → 상세로
      el.addEventListener('click', ()=> {
        location.href = `reviewdetail.html?id=${review.id}`;
      });

      // 내 리뷰 탭일 때만: 수정/삭제 핸들러
      if (CURRENT_TAB === 'mine') {
        const editBtn = el.querySelector('.btn-edit');
        const delBtn  = el.querySelector('.btn-del');

        if (editBtn) {
          editBtn.addEventListener('click', (e)=>{
            e.stopPropagation(); // 카드 클릭 막기
            location.href = `editreview.html?id=${review.id}`;
          });
        }

        if (delBtn) {
          delBtn.addEventListener('click', async (e)=>{
            e.stopPropagation(); // 카드 클릭 막기
            if(!confirm('이 리뷰를 삭제하시겠습니까?')) return;

            try{
              const r = await fetch(`/api/reviews/${review.id}`, {
                method:'DELETE',
                credentials:'include'
              });
              if(!r.ok) throw new Error('삭제 실패');

              // 현재 목록에서 제거 후 재렌더
              MY_LIST = MY_LIST.filter(x => x.id !== review.id);
              render(MY_LIST);
            }catch(err){
              alert(err.message || '삭제에 실패했습니다.');
            }
          });
        }
      }

      grid.appendChild(el);
    });
  }

    async function loadMine(){
      const sort = document.getElementById('sortSelect').value;
      const r = await fetch(`/api/reviews/mine?sort=${encodeURIComponent(sort)}`, { credentials:'include' });
      if(!r.ok) throw new Error('내 리뷰 불러오기 실패');
      return r.json();
    }

    async function loadBookmarks(){
      const sort = document.getElementById('sortSelect').value;
      const r = await fetch(`/api/bookmarks/mine?sort=${encodeURIComponent(sort)}`, { credentials:'include' });
      if(!r.ok) throw new Error('북마크 불러오기 실패');
      return r.json();
    }

    async function loadCurrent(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '<p>불러오는 중...</p>';
      try{
        MY_LIST = CURRENT_TAB === 'mine' ? await loadMine() : await loadBookmarks();
        render(MY_LIST);
      }catch(e){
        console.error(e);
        grid.innerHTML = '<p>목록을 불러오지 못했습니다.</p>';
      }
    }

    // 탭/정렬 이벤트 바인딩
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('#tabs [data-mode]');
      const sortSel = document.getElementById('sortSelect');

      // 탭 활성화 + 데이터 로드
      function setActive(mode){
         CURRENT_TAB = mode;
        tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
        loadCurrent();
      }

      // 각 탭에 클릭 핸들러 연결
      tabs.forEach(btn => {
        btn.addEventListener('click', () => setActive(btn.dataset.mode));
      });

      // 정렬 변경 시 재로딩
      sortSel?.addEventListener('change', loadCurrent);

      // 초기: 내 리뷰 탭 선택
      setActive('mine');
    });
  </script>


  <script>
    (function initAuth(){
      fetch('/check-auth', { credentials:'include' })
        .then(function(r){ return r.json(); })
        .then(function(d){
          if(!d.loggedIn) return;
          const el = document.querySelector('.auth-links');
          if(!el) return;
          el.innerHTML =
            '<div style="position: relative;">' +
              '<button id="mypageBtn" style="background:none;border:none;color:white;cursor:pointer;">마이페이지 ▾</button>' +
              '<div id="mypageDropdown" style="display:none;position:absolute;right:0;background:white;color:black;padding:10px;border-radius:5px;min-width:120px;">' +
                '<a href="mypage.html" style="color:black;text-decoration:none;">내 정보 확인</a><br>' +
                '<a href="editprofile.html" style="color:black;text-decoration:none;">프로필 수정</a><br>' +
                '<a href="#" id="logoutLink" style="color:black;text-decoration:none;">로그아웃</a>' +
              '</div>' +
            '</div>';

          var btn = document.getElementById('mypageBtn');
          if(btn){
            btn.addEventListener('click', function(){
              var dd = document.getElementById('mypageDropdown');
              dd.style.display = (dd.style.display === 'none' || !dd.style.display) ? 'block' : 'none';
            });
          }
          var lo = document.getElementById('logoutLink');
          if(lo){
            lo.addEventListener('click', function(e){
              e.preventDefault();
              fetch('/logout', { credentials:'include' }).then(function(){ location.href='/'; });
            });
          }
        });
    })();
  </script>
</body>
</html>
