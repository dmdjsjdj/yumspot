<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¦¬ë·° ìƒì„¸ - YumSpot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#E3F2FD; margin:0; }
    .header { text-align:center; padding:20px; font-size:24px; font-weight:bold; background:#90CAF9; color:#fff; }
    .header a { color:#fff; text-decoration:none; }
    .navbar { background:#90CAF9; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .center-links { flex:1; display:flex; justify-content:center; gap:30px; margin-left:90px; }
    .center-links a, .auth-links a { color:#fff; text-decoration:none; }
    .auth-links { display:flex; gap:7px; }
    .container { max-width:860px; margin:20px auto; padding:0 10px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .rating { letter-spacing:1px; }
    .empty { opacity:.4; }
    .top { display:flex; justify-content:space-between; align-items:center; }
    .btn { padding:10px 14px; background:#64B5F6; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    img { max-width:100%; border-radius:8px; margin:12px 0; }
    .meta { color:#555; font-size:14px; }

    .detail-image{
      width: 70%;
      height: 460px;   
      object-fit: contain;
      display: block;
      border-radius: 8px;
      background: #f6f8fb;
    }

    .gallery { position: relative; width: 100%; max-width: 720px; margin: 12px 0; }
    .gallery-viewport { overflow: hidden; border-radius: 8px; background:#f6f8fb; }
    .gallery-track { display: flex; transition: transform .3s ease; }
    .gallery-track img { width: 100%; height: 460px; object-fit: contain; flex: 0 0 100%; }

    .gallery-nav { position:absolute; top:50%; transform:translateY(-50%); 
      background:rgba(0,0,0,.4); color:#fff; border:none; width:38px; height:38px; 
      border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .gallery-prev { left:8px; }
    .gallery-next { right:8px; }
    .gallery-dots { display:flex; gap:6px; justify-content:center; margin-top:8px; }
    .gallery-dot { width:8px; height:8px; border-radius:50%; background:#cfd8dc; cursor:pointer; }
    .gallery-dot.active { background:#607d8b; }

  </style>
  <script src="/utils/categoryLists.js"></script>
</head>
<body>
  <div class="header"><a href="/">YumSpot - ë§›ì§‘ì„ ì°¾ì•„ë³´ì!</a></div>
  <div class="navbar">
    <div class="center-links">
      <a href="regionreview.html">ì§€ì—­ë³„</a>
      <a href="foodreview.html">ìŒì‹</a>
      <a href="myreview.html">ë‚´ ë¦¬ë·°</a>
    </div>
    <div class="auth-links">
      <a href="login.html">ë¡œê·¸ì¸</a>
      <a href="signup.html">íšŒì›ê°€ì…</a>
    </div>
  </div>

  <div class="container">
    <div id="card" class="card"></div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    // ë‚ ì§œ í‘œì‹œ í—¬í¼
    function fmtDate(s){
      if(!s) return '-';
      const d = new Date(s);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'});
    }

    async function loadDetail(){
      const el = document.getElementById('card');
      el.innerHTML = '';

      // 1) id ìœ íš¨ì„±
      if(!id){
        el.innerHTML = '<p>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (id ì—†ìŒ)</p>';
        return;
      }

      try{
        const res = await fetch(`/api/reviews/${encodeURIComponent(id)}`);
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          console.error('[detail] HTTP', res.status, txt);
          throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
        }
        const review = await res.json();

        // 2) ì†Œìœ ì íŒë‹¨(ë°±ì—”ë“œì—ì„œ isOwner ë‚´ë ¤ì£¼ì§€ë§Œ ë°©ì–´)
        let isOwner = !!review.isOwner;
        if(!isOwner && typeof review.user_id !== 'undefined'){
          try {
            const meRes = await fetch('/api/me', { credentials:'include' });
            if (meRes.ok) {
              const me = await meRes.json();
              if (me && (me.id === review.user_id || me.user_id === review.user_id)) isOwner = true;
            }
          } catch(_) {}
        }

        const stars = 'â˜…'.repeat(Number(review.rating)||0) +
                      '<span class="empty">' + 'â˜†'.repeat(5-(Number(review.rating)||0)) + '</span>';

        // ì´ë¯¸ì§€ ë°°ì—´: ì—¬ëŸ¬ì¥ ìš°ì„ , ì—†ìœ¼ë©´ ë‹¨ì¼, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
        const imgs = (Array.isArray(review.image_urls) && review.image_urls.length > 0)
          ? review.image_urls
          : (review.image_url ? [review.image_url] : []);

        el.innerHTML = `
          <div class="top">
            <h2>${review.title}</h2>
            <div>
              <button class="btn" id="bookmarkBtn">
                <span id="bmIcon">â˜†</span>
                <span id="bmText">ë¶ë§ˆí¬</span>
                (<span id="bmCnt">0</span>)
              </button>
              ${isOwner ? `
                <button class="btn" id="editBtn">ìˆ˜ì •</button>
                <button class="btn" id="delBtn" style="background:#ef5350;">ì‚­ì œ</button>
              ` : ``}
              <button class="btn" onclick="history.back()">ë’¤ë¡œ</button>
            </div>
          </div>
          <p class="rating">${stars}</p>
          <p class="meta">ì‘ì„±ì¼: ${fmtDate(review.created_at)}</p>
          <p class="meta">ì¹´í…Œê³ ë¦¬: ${review.foodcategory ?? '-'} | ì§€ì—­: ${review.regionnames ?? '-'}</p>
          <p class="meta">ì‹ë‹¹: ${review.restaurant_name ?? ''}</p>
          <p class="meta">ì£¼ì†Œ: <span id="addr">${review.address ?? ''}</span>
            <button class="btn" style="padding:6px 10px;" onclick="copyAddr()">ë³µì‚¬</button>
          </p>

          ${
            imgs.length > 0
              ? `
                <div class="gallery" id="gallery">
                  <div class="gallery-viewport">
                    <div class="gallery-track">
                      ${imgs.map(u => `<img src="${u}" alt="review image">`).join('')}
                    </div>
                  </div>
                  ${imgs.length > 1 ? `
                    <button class="gallery-nav gallery-prev" aria-label="ì´ì „">â€¹</button>
                    <button class="gallery-nav gallery-next" aria-label="ë‹¤ìŒ">â€º</button>
                    <div class="gallery-dots">
                      ${imgs.map((_,i)=>`<div class="gallery-dot ${i===0?'active':''}" data-idx="${i}"></div>`).join('')}
                    </div>
                  ` : ``}
                </div>
              ` : ``
          }

          <p>${(review.content||'').replace(/\n/g,'<br>')}</p>
          <div id="map" style="width:100%;height:300px;border-radius:8px;margin-top:10px;"></div>
        `;

        // ê°¤ëŸ¬ë¦¬(ìŠ¬ë¼ì´ë”) ì´ˆê¸°í™”
        (function initGallery(){
          const root = document.getElementById('gallery');
          if (!root) return; // ì´ë¯¸ì§€ ì—†ìŒ

          const track = root.querySelector('.gallery-track');
          const prev  = root.querySelector('.gallery-prev');
          const next  = root.querySelector('.gallery-next');
          const dots  = [...root.querySelectorAll('.gallery-dot')];

          let idx = 0;
          const total = track.children.length;

          function go(i){
            idx = Math.max(0, Math.min(total-1, i));
            track.style.transform = `translateX(-${idx*100}%)`;
            dots.forEach((d,di)=> d.classList.toggle('active', di===idx));
          }

          prev?.addEventListener('click', (e)=>{ e.stopPropagation(); go(idx-1); });
          next?.addEventListener('click', (e)=>{ e.stopPropagation(); go(idx+1); });
          dots.forEach(d => d.addEventListener('click', (e)=> {
            e.stopPropagation(); go(Number(d.dataset.idx)||0);
          }));

          // ìŠ¤ì™€ì´í”„(ëª¨ë°”ì¼)
          let sx = 0, dx = 0;
          track.addEventListener('touchstart', e=> { sx = e.touches[0].clientX; dx = 0; }, {passive:true});
          track.addEventListener('touchmove',  e=> { dx = e.touches[0].clientX - sx; }, {passive:true});
          track.addEventListener('touchend',   ()=> {
            if (Math.abs(dx) > 40) { go(idx + (dx<0 ? 1 : -1)); }
            sx = dx = 0;
          });

          // ì²« ìŠ¬ë¼ì´ë“œ
          go(0);
        })();

        function setBookmarkUI({bookmarked, count}) {
          const bmIcon = document.getElementById('bmIcon');
          const bmText = document.getElementById('bmText');
          const bmCnt  = document.getElementById('bmCnt');
          if (bmIcon) bmIcon.textContent = bookmarked ? 'â˜…' : 'â˜†';
          if (bmText) bmText.textContent = bookmarked ? 'ë¶ë§ˆí¬' : 'ë¶ë§ˆí¬';
          if (bmCnt)  bmCnt.textContent  = String(count ?? 0);
        }

        // âœ… ë²„íŠ¼ DOMì„ ë¨¼ì € ì¡ê¸°
        const bmBtn = document.getElementById('bookmarkBtn');
        if (bmBtn) {
          // ì´ˆê¸° ìƒíƒœ/ì¹´ìš´íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
          let bookmarked = false;
          let count = 0;
          try {
            const stateRes = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, { credentials:'include' });
            if (stateRes.ok) {
              const st = await stateRes.json();
              bookmarked = !!st.bookmarked;
              count = st.count || 0;
            }
          } catch(_) { /* noop */ }
          setBookmarkUI({ bookmarked, count });

          // í´ë¦­ í† ê¸€
          bmBtn.addEventListener('click', async () => {
            try {
              const method = bookmarked ? 'DELETE' : 'POST';
              const r = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, {
                method, credentials:'include'
              });
              if (r.status === 401) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href = 'login.html'; return; }
              if (!r.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨');

              // ğŸ” ì„œë²„ ì‘ë‹µì´ count/ìƒíƒœë¥¼ ì•ˆ ì£¼ë©´, GETìœ¼ë¡œ ìµœì‹  ìƒíƒœ ë‹¤ì‹œ ì¡°íšŒ
              const s = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, { credentials:'include' })
                                .then(x => x.json());
              bookmarked = !!s.bookmarked;
              count = s.count || 0;
              setBookmarkUI({ bookmarked, count });
            } catch (e) {
              alert(e.message || 'ì˜¤ë¥˜ ë°œìƒ');
            }
          });
        }

        // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
        if(isOwner){
          document.getElementById('editBtn').addEventListener('click', ()=>{
            location.href = `editreview.html?id=${review.id}`;
          });
          document.getElementById('delBtn').addEventListener('click', async ()=>{
            if(!confirm('ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try{
              const r = await fetch(`/api/reviews/${review.id}`, { method:'DELETE', credentials:'include' });
              if(!r.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
              alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              location.href = 'myreview.html';
            }catch(e){ alert(e.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
          });
        }

        // ì§€ë„ ë¡œë”©
        const run = () => renderMap(review);
        if (window.kakao?.maps?.load) {
          kakao.maps.load(run);
        } else {
          const sdk = document.querySelector('script[src*="dapi.kakao.com"]');
          if (sdk) {
            sdk.addEventListener('load', () => kakao.maps.load(run), { once:true });
          } else {
            window.addEventListener('load', () => kakao.maps.load(run), { once:true });
          }
        }
      }catch(e){
        console.error('[detail] ì‹¤íŒ¨:', e);
        el.innerHTML = '<p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    function renderMap(review){
      const $map = document.getElementById('map');

      // ê³µí†µ ë“œë¡œì‰
      function draw(lat, lng){
        const center = new kakao.maps.LatLng(lat, lng);
        const map = new kakao.maps.Map($map, { center, level: 3 });
        new kakao.maps.Marker({ position: center, map });
      }

      // 0) ì¢Œí‘œê°€ ì´ë¯¸ ì €ì¥ë¼ ìˆìœ¼ë©´ ë°”ë¡œ
      if (review.lat != null && review.lng != null) {
        draw(Number(review.lat), Number(review.lng));
        return;
      }

      const places = new kakao.maps.services.Places();
      const geocoder = new kakao.maps.services.Geocoder();

      // 1) ì£¼ì†Œê°€ ìˆìœ¼ë©´ ë¨¼ì € ì£¼ì†Œ ì§€ì˜¤ì½”ë”© ì‹œë„ (ì„±ê³µë¥  ê°€ì¥ ë†’ìŒ)
      const tryAddress = () => new Promise((resolve) => {
        if(!review.address) return resolve(null);
        geocoder.addressSearch(review.address, (result, status) => {
          if (status === kakao.maps.services.Status.OK && result?.length) {
            const { y, x } = result[0]; // y=lat, x=lng
            resolve({ lat: Number(y), lng: Number(x) });
          } else resolve(null);
        });
      });

      // 2) í‚¤ì›Œë“œ(ì‹ë‹¹ëª… + ì£¼ì†Œ ì¼ë¶€) ê²€ìƒ‰
      const tryKeyword = () => new Promise((resolve) => {
        const q = review.restaurant_name
          ? (review.address ? `${review.restaurant_name} ${review.address}` : review.restaurant_name)
          : review.address;

        if(!q) return resolve(null);

        places.keywordSearch(q, (data, status) => {
          if (status === kakao.maps.services.Status.OK && data?.length) {
            resolve({ lat: Number(data[0].y), lng: Number(data[0].x) });
          } else resolve(null);
        });
      });

      // ìˆœì°¨ ì‹œë„
      (async ()=>{
        let coord = await tryAddress();
        if(!coord) coord = await tryKeyword();

        if(coord) {
          draw(coord.lat, coord.lng);
        } else {
          $map.innerHTML = '<p style="color:#555">ì§€ë„ ì •ë³´ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      })();
    }

    function copyAddr(){
      const txt = document.getElementById('addr')?.textContent || '';
      navigator.clipboard.writeText(txt).then(()=>alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    }

    window.onload = loadDetail;
  </script>

  <script>
  (function initAuth(){
    fetch('/check-auth', { credentials: 'include' })
      .then(r=>r.json())
      .then(d=>{
        if(!d.loggedIn) return;
        const el = document.querySelector('.auth-links');
        if(!el) return;
        el.innerHTML = `
          <div style="position: relative;">
            <button id="mypageBtn" style="background:none;border:none;color:white;cursor:pointer;">ë§ˆì´í˜ì´ì§€ â–¾</button>
            <div id="mypageDropdown" style="display:none;position:absolute;right:0;background:white;color:black;padding:10px;border-radius:5px;min-width:100px;">
              <a href="mypage.html" style="color:black;text-decoration:none;">ë‚´ ì •ë³´ í™•ì¸</a><br>
              <a href="editprofile.html" style="color:black;text-decoration:none;">í”„ë¡œí•„ ìˆ˜ì •</a><br>
              <a href="#" id="logoutLink" style="color:black;text-decoration:none;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
          </div>`;
        document.getElementById("mypageBtn")?.addEventListener("click",()=>{
          const dd = document.getElementById("mypageDropdown");
          dd.style.display = dd.style.display === "none" ? "block" : "none";
        });
        document.getElementById("logoutLink")?.addEventListener("click",(e)=>{
          e.preventDefault();
          fetch('/logout', { credentials:'include' }).then(()=>location.href='/');
        });
      });
  })();
  </script>
  <!-- Kakao JS SDK (services ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3382e6a214a404a815ed75a04889a2cd&libraries=services&autoload=false"></script>
</body>
</html>
