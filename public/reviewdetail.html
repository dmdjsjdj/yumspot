<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>리뷰 상세 - YumSpot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#E3F2FD; margin:0; }
    .header { text-align:center; padding:20px; font-size:24px; font-weight:bold; background:#90CAF9; color:#fff; }
    .header a { color:#fff; text-decoration:none; }
    .navbar { background:#90CAF9; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .center-links { flex:1; display:flex; justify-content:center; gap:30px; margin-left:90px; }
    .center-links a, .auth-links a { color:#fff; text-decoration:none; }
    .auth-links { display:flex; gap:7px; }
    .container { max-width:860px; margin:20px auto; padding:0 10px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .rating { letter-spacing:1px; }
    .empty { opacity:.4; }
    .top { display:flex; justify-content:space-between; align-items:center; }
    .btn { padding:10px 14px; background:#64B5F6; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    img { max-width:100%; border-radius:8px; margin:12px 0; }
    .meta { color:#555; font-size:14px; }

    .detail-image{
      width: 70%;
      height: 460px;   
      object-fit: contain;
      display: block;
      border-radius: 8px;
      background: #f6f8fb;
    }

    .gallery { position: relative; width: 100%; max-width: 720px; margin: 12px 0; }
    .gallery-viewport { overflow: hidden; border-radius: 8px; background:#f6f8fb; }
    .gallery-track { display: flex; transition: transform .3s ease; }
    .gallery-track img { width: 100%; height: 460px; object-fit: contain; flex: 0 0 100%; }

    .gallery-nav { position:absolute; top:50%; transform:translateY(-50%); 
      background:rgba(0,0,0,.4); color:#fff; border:none; width:38px; height:38px; 
      border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .gallery-prev { left:8px; }
    .gallery-next { right:8px; }
    .gallery-dots { display:flex; gap:6px; justify-content:center; margin-top:8px; }
    .gallery-dot { width:8px; height:8px; border-radius:50%; background:#cfd8dc; cursor:pointer; }
    .gallery-dot.active { background:#607d8b; }

  </style>
  <script src="/utils/categoryLists.js"></script>
</head>
<body>
  <div class="header"><a href="/">YumSpot - 맛집을 찾아보자!</a></div>
  <div class="navbar">
    <div class="center-links">
      <a href="regionreview.html">지역별</a>
      <a href="foodreview.html">음식</a>
      <a href="myreview.html">내 리뷰</a>
    </div>
    <div class="auth-links">
      <a href="login.html">로그인</a>
      <a href="signup.html">회원가입</a>
    </div>
  </div>

  <div class="container">
    <div id="card" class="card"></div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    // 날짜 표시 헬퍼
    function fmtDate(s){
      if(!s) return '-';
      const d = new Date(s);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'});
    }

    async function loadDetail(){
      const el = document.getElementById('card');
      el.innerHTML = '';

      // 1) id 유효성
      if(!id){
        el.innerHTML = '<p>잘못된 접근입니다. (id 없음)</p>';
        return;
      }

      try{
        const res = await fetch(`/api/reviews/${encodeURIComponent(id)}`);
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          console.error('[detail] HTTP', res.status, txt);
          throw new Error('불러오기 실패');
        }
        const review = await res.json();

        // 2) 소유자 판단(백엔드에서 isOwner 내려주지만 방어)
        let isOwner = !!review.isOwner;
        if(!isOwner && typeof review.user_id !== 'undefined'){
          try {
            const meRes = await fetch('/api/me', { credentials:'include' });
            if (meRes.ok) {
              const me = await meRes.json();
              if (me && (me.id === review.user_id || me.user_id === review.user_id)) isOwner = true;
            }
          } catch(_) {}
        }

        const stars = '★'.repeat(Number(review.rating)||0) +
                      '<span class="empty">' + '☆'.repeat(5-(Number(review.rating)||0)) + '</span>';

        // 이미지 배열: 여러장 우선, 없으면 단일, 둘 다 없으면 빈 배열
        const imgs = (Array.isArray(review.image_urls) && review.image_urls.length > 0)
          ? review.image_urls
          : (review.image_url ? [review.image_url] : []);

        el.innerHTML = `
          <div class="top">
            <h2>${review.title}</h2>
            <div>
              <button class="btn" id="bookmarkBtn">
                <span id="bmIcon">☆</span>
                <span id="bmText">북마크</span>
                (<span id="bmCnt">0</span>)
              </button>
              ${isOwner ? `
                <button class="btn" id="editBtn">수정</button>
                <button class="btn" id="delBtn" style="background:#ef5350;">삭제</button>
              ` : ``}
              <button class="btn" onclick="history.back()">뒤로</button>
            </div>
          </div>
          <p class="rating">${stars}</p>
          <p class="meta">작성일: ${fmtDate(review.created_at)}</p>
          <p class="meta">카테고리: ${review.foodcategory ?? '-'} | 지역: ${review.regionnames ?? '-'}</p>
          <p class="meta">식당: ${review.restaurant_name ?? ''}</p>
          <p class="meta">주소: <span id="addr">${review.address ?? ''}</span>
            <button class="btn" style="padding:6px 10px;" onclick="copyAddr()">복사</button>
          </p>

          ${
            imgs.length > 0
              ? `
                <div class="gallery" id="gallery">
                  <div class="gallery-viewport">
                    <div class="gallery-track">
                      ${imgs.map(u => `<img src="${u}" alt="review image">`).join('')}
                    </div>
                  </div>
                  ${imgs.length > 1 ? `
                    <button class="gallery-nav gallery-prev" aria-label="이전">‹</button>
                    <button class="gallery-nav gallery-next" aria-label="다음">›</button>
                    <div class="gallery-dots">
                      ${imgs.map((_,i)=>`<div class="gallery-dot ${i===0?'active':''}" data-idx="${i}"></div>`).join('')}
                    </div>
                  ` : ``}
                </div>
              ` : ``
          }

          <p>${(review.content||'').replace(/\n/g,'<br>')}</p>
          <div id="map" style="width:100%;height:300px;border-radius:8px;margin-top:10px;"></div>
        `;

        // 갤러리(슬라이더) 초기화
        (function initGallery(){
          const root = document.getElementById('gallery');
          if (!root) return; // 이미지 없음

          const track = root.querySelector('.gallery-track');
          const prev  = root.querySelector('.gallery-prev');
          const next  = root.querySelector('.gallery-next');
          const dots  = [...root.querySelectorAll('.gallery-dot')];

          let idx = 0;
          const total = track.children.length;

          function go(i){
            idx = Math.max(0, Math.min(total-1, i));
            track.style.transform = `translateX(-${idx*100}%)`;
            dots.forEach((d,di)=> d.classList.toggle('active', di===idx));
          }

          prev?.addEventListener('click', (e)=>{ e.stopPropagation(); go(idx-1); });
          next?.addEventListener('click', (e)=>{ e.stopPropagation(); go(idx+1); });
          dots.forEach(d => d.addEventListener('click', (e)=> {
            e.stopPropagation(); go(Number(d.dataset.idx)||0);
          }));

          // 스와이프(모바일)
          let sx = 0, dx = 0;
          track.addEventListener('touchstart', e=> { sx = e.touches[0].clientX; dx = 0; }, {passive:true});
          track.addEventListener('touchmove',  e=> { dx = e.touches[0].clientX - sx; }, {passive:true});
          track.addEventListener('touchend',   ()=> {
            if (Math.abs(dx) > 40) { go(idx + (dx<0 ? 1 : -1)); }
            sx = dx = 0;
          });

          // 첫 슬라이드
          go(0);
        })();

        function setBookmarkUI({bookmarked, count}) {
          const bmIcon = document.getElementById('bmIcon');
          const bmText = document.getElementById('bmText');
          const bmCnt  = document.getElementById('bmCnt');
          if (bmIcon) bmIcon.textContent = bookmarked ? '★' : '☆';
          if (bmText) bmText.textContent = bookmarked ? '북마크' : '북마크';
          if (bmCnt)  bmCnt.textContent  = String(count ?? 0);
        }

        // ✅ 버튼 DOM을 먼저 잡기
        const bmBtn = document.getElementById('bookmarkBtn');
        if (bmBtn) {
          // 초기 상태/카운트 불러오기
          let bookmarked = false;
          let count = 0;
          try {
            const stateRes = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, { credentials:'include' });
            if (stateRes.ok) {
              const st = await stateRes.json();
              bookmarked = !!st.bookmarked;
              count = st.count || 0;
            }
          } catch(_) { /* noop */ }
          setBookmarkUI({ bookmarked, count });

          // 클릭 토글
          bmBtn.addEventListener('click', async () => {
            try {
              const method = bookmarked ? 'DELETE' : 'POST';
              const r = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, {
                method, credentials:'include'
              });
              if (r.status === 401) { alert('로그인이 필요합니다.'); location.href = 'login.html'; return; }
              if (!r.ok) throw new Error('요청 실패');

              // 🔁 서버 응답이 count/상태를 안 주면, GET으로 최신 상태 다시 조회
              const s = await fetch(`/api/bookmarks/${encodeURIComponent(review.id)}`, { credentials:'include' })
                                .then(x => x.json());
              bookmarked = !!s.bookmarked;
              count = s.count || 0;
              setBookmarkUI({ bookmarked, count });
            } catch (e) {
              alert(e.message || '오류 발생');
            }
          });
        }

        // 수정/삭제 버튼
        if(isOwner){
          document.getElementById('editBtn').addEventListener('click', ()=>{
            location.href = `editreview.html?id=${review.id}`;
          });
          document.getElementById('delBtn').addEventListener('click', async ()=>{
            if(!confirm('이 리뷰를 삭제하시겠습니까?')) return;
            try{
              const r = await fetch(`/api/reviews/${review.id}`, { method:'DELETE', credentials:'include' });
              if(!r.ok) throw new Error('삭제 실패');
              alert('삭제되었습니다.');
              location.href = 'myreview.html';
            }catch(e){ alert(e.message || '삭제에 실패했습니다.'); }
          });
        }

        // 지도 로딩
        const run = () => renderMap(review);
        if (window.kakao?.maps?.load) {
          kakao.maps.load(run);
        } else {
          const sdk = document.querySelector('script[src*="dapi.kakao.com"]');
          if (sdk) {
            sdk.addEventListener('load', () => kakao.maps.load(run), { once:true });
          } else {
            window.addEventListener('load', () => kakao.maps.load(run), { once:true });
          }
        }
      }catch(e){
        console.error('[detail] 실패:', e);
        el.innerHTML = '<p>리뷰를 불러오지 못했습니다.</p>';
      }
    }

    function renderMap(review){
      const $map = document.getElementById('map');

      // 공통 드로잉
      function draw(lat, lng){
        const center = new kakao.maps.LatLng(lat, lng);
        const map = new kakao.maps.Map($map, { center, level: 3 });
        new kakao.maps.Marker({ position: center, map });
      }

      // 0) 좌표가 이미 저장돼 있으면 바로
      if (review.lat != null && review.lng != null) {
        draw(Number(review.lat), Number(review.lng));
        return;
      }

      const places = new kakao.maps.services.Places();
      const geocoder = new kakao.maps.services.Geocoder();

      // 1) 주소가 있으면 먼저 주소 지오코딩 시도 (성공률 가장 높음)
      const tryAddress = () => new Promise((resolve) => {
        if(!review.address) return resolve(null);
        geocoder.addressSearch(review.address, (result, status) => {
          if (status === kakao.maps.services.Status.OK && result?.length) {
            const { y, x } = result[0]; // y=lat, x=lng
            resolve({ lat: Number(y), lng: Number(x) });
          } else resolve(null);
        });
      });

      // 2) 키워드(식당명 + 주소 일부) 검색
      const tryKeyword = () => new Promise((resolve) => {
        const q = review.restaurant_name
          ? (review.address ? `${review.restaurant_name} ${review.address}` : review.restaurant_name)
          : review.address;

        if(!q) return resolve(null);

        places.keywordSearch(q, (data, status) => {
          if (status === kakao.maps.services.Status.OK && data?.length) {
            resolve({ lat: Number(data[0].y), lng: Number(data[0].x) });
          } else resolve(null);
        });
      });

      // 순차 시도
      (async ()=>{
        let coord = await tryAddress();
        if(!coord) coord = await tryKeyword();

        if(coord) {
          draw(coord.lat, coord.lng);
        } else {
          $map.innerHTML = '<p style="color:#555">지도 정보를 표시할 수 없습니다.</p>';
        }
      })();
    }

    function copyAddr(){
      const txt = document.getElementById('addr')?.textContent || '';
      navigator.clipboard.writeText(txt).then(()=>alert('주소가 복사되었습니다.'));
    }

    window.onload = loadDetail;
  </script>

  <script>
  (function initAuth(){
    fetch('/check-auth', { credentials: 'include' })
      .then(r=>r.json())
      .then(d=>{
        if(!d.loggedIn) return;
        const el = document.querySelector('.auth-links');
        if(!el) return;
        el.innerHTML = `
          <div style="position: relative;">
            <button id="mypageBtn" style="background:none;border:none;color:white;cursor:pointer;">마이페이지 ▾</button>
            <div id="mypageDropdown" style="display:none;position:absolute;right:0;background:white;color:black;padding:10px;border-radius:5px;min-width:100px;">
              <a href="mypage.html" style="color:black;text-decoration:none;">내 정보 확인</a><br>
              <a href="editprofile.html" style="color:black;text-decoration:none;">프로필 수정</a><br>
              <a href="#" id="logoutLink" style="color:black;text-decoration:none;">로그아웃</a>
            </div>
          </div>`;
        document.getElementById("mypageBtn")?.addEventListener("click",()=>{
          const dd = document.getElementById("mypageDropdown");
          dd.style.display = dd.style.display === "none" ? "block" : "none";
        });
        document.getElementById("logoutLink")?.addEventListener("click",(e)=>{
          e.preventDefault();
          fetch('/logout', { credentials:'include' }).then(()=>location.href='/');
        });
      });
  })();
  </script>
  <!-- Kakao JS SDK (services 라이브러리 포함) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3382e6a214a404a815ed75a04889a2cd&libraries=services&autoload=false"></script>
</body>
</html>
